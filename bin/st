#!/usr/bin/env bash
#########################################################################
# syncing - a bask extension script
#
# Add this script and %s to your \$PATH. For usage information, run:
# syncing help
#########################################################################

source "$(which bask)"

desc start <<HEREDOC
Usage:
  $_ME start

Description:
  Start syncthing.
HEREDOC
start() {
  brew services start syncthing
}

desc status <<HEREDOC
Usage:
  $_ME status

Description:
  Get the status.
HEREDOC
status() {
  local _api_key
  _api_key="$(
    grep 'apikey' "${HOME}/Library/Application Support/Syncthing/config.xml" \
      | sed -e 's,.*<apikey>\([^<]*\)</apikey>.*,\1,g'
  )"

  if [[ -z "${_api_key}" ]]
  then
    printf "API Key not found.\n"
    exit 1
  fi

  curl -s -H "X-API-KEY: ${_api_key}" http://localhost:8384/rest/stats/folder | jq

  curl \
    -s \
    -H "X-API-KEY: ${_api_key}" \
    http://localhost:8384/rest/db/completion | jq

  curl \
    -s \
    -H "X-API-KEY: ${_api_key}" \
    http://localhost:8384/rest/db/status | jq
}

desc stop <<HEREDOC
Usage:
  $_ME stop

Description:
  Stop syncthing.
HEREDOC
stop() {
  brew services stop syncthing
}

_main
