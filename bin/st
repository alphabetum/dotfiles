#!/usr/bin/env bash
#########################################################################
# syncing - a bask extension script
#
# Add this script and %s to your \$PATH. For usage information, run:
# syncing help
#########################################################################

source "$(which bask)"

desc setup <<EOM
Usage:
  $_ME setup

Description:
  Set up syncthing.
EOM
setup() {
  if [[ ! -e "${HOME}/Library/LaunchAgents/homebrew.mxcl.syncthing.plist" ]]
  then
    ln -sfv /usr/local/opt/syncthing/*.plist "${HOME}/Library/LaunchAgents"
  fi
}

desc start <<EOM
Usage:
  $_ME start

Description:
  Start syncthing. A shortcut for the following:

  launchctl load ~/Library/LaunchAgents/homebrew.mxcl.syncthing.plist
EOM
start() {
  printf "Starting syncthing...\n"

  $_ME setup

  launchctl load ~/Library/LaunchAgents/homebrew.mxcl.syncthing.plist
}

desc status <<EOM
Usage:
  $_ME status

Description:
  Get the status.
EOM
status() {
  local _api_key
  _api_key="$(
    grep 'apikey' "${HOME}/Library/Application Support/Syncthing/config.xml" \
      | sed -e 's,.*<apikey>\([^<]*\)</apikey>.*,\1,g'
  )"

  if [[ -z "${_api_key}" ]]
  then
    printf "API Key not found.\n"
    exit 1
  fi

  curl -s -H "X-API-KEY: ${_api_key}" http://localhost:8384/rest/stats/folder | jq

  curl \
    -s \
    -H "X-API-KEY: ${_api_key}" \
    http://localhost:8384/rest/db/completion | jq

  curl \
    -s \
    -H "X-API-KEY: ${_api_key}" \
    http://localhost:8384/rest/db/status | jq
}

desc stop <<EOM
Usage:
  $_ME stop

Description:
  Stop syncthing. A shortcut for the following:

  launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.syncthing.plist
EOM
stop() {
  printf "Stopping syncthing...\n"
  launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.syncthing.plist
}

_main
