#!/usr/bin/env bash
###############################################################################
# Bootstrap dotfiles on a fresh ubuntu install
###############################################################################

###############################################################################
# Platform Check
###############################################################################

# Skip unless ubuntu
if [[ ! "$(cat /etc/issue 2> /dev/null)" =~ Ubuntu ]]; then
  printf "Ubuntu bootstrapping is only supported on Ubuntu.\nSkipping...\n"
  exit 0
fi

###############################################################################
# Bootstrap
###############################################################################

# Might as well ask for password up-front, right?
sudo -v
# Keep-alive: update existing sudo time stamp if set, otherwise do nothing.
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

#------------------------------------------------------------------------------

export DOTSPATH="${HOME}/.dotfiles"

"${DOTSPATH}/script/install/apt-packages"

if [[ ! -e "${HOME}/bin" ]]; then
  mkdir "${HOME}/bin"
fi

cp "${HOME}/.ssh/*" "${HOME}/.dotfiles/home/.ssh/" && \
  cd "${DOTSPATH}" && \
  git submodule init && \
  git submodule update --init --recursive && \
  ./bin/dots link --overwrite --with-backup && \
  ./bin/dots bin link

# Bootstrap janus
"${DOTSPATH}/home/.vim/bootstrap.sh"

sudo chsh -s "$(which zsh)" "$(whoami)"

"$(which zsh)" --login
